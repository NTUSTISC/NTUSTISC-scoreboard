<!DOCTYPE html>
<html>

<head>
	<title>Scoreboard</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.css" />
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
	<style>
		.container {
			margin-top: 3em;
		}
		footer {
			position: static;
			margin-top: 3em;
			margin-bottom: 0px;
			color: #AAAAAA
		}
		.circular-chart {
			display: block;
			margin: 10px auto;
			max-width: 80%;
			max-height: 250px;
		}
		.circle {
			stroke: #4CC790;
			fill: none;
			stroke-width: 2.8;
			stroke-linecap: round;
			animation: progress 0.5s ease-out forwards;
		}
		@keyframes progress {
			0% {
				stroke-dasharray: 0 100;
			}
		}
		.circle-bg {
			fill: none;
			stroke: #eee;
			stroke-width: 3.8;
		}
		.percentage {
			fill: #666;
			font-family: sans-serif;
			font-size: 0.5em;
			text-anchor: middle;
		}
	</style>
</head>

<body>
	<section class="hero is-primary">
		<div class="hero-body">
			<div class="container">
				<h1 class="title">
					台科資安社 | 試煉場
				</h1>
				<h2 class="subtitle">
					NTUSTISC
				</h2>
			</div>
		</div>
	</section>

	<div class="container">

		<div class="columns">
			<!-- Main Section -->
			<div class="column is-four-fifths">
				<!-- Challenges -->
				<h1 class="title">
					Challenges
				</h1>
				<table class="table is-hoverable is-fullwidth">
					<thead>
						<tr>
							<th>Type</th>
							<th>Name</th>
							<th>Solved</th>
							<th>Description</th>
						</tr>
					</thead>
					<tbody>
						{% for challenge in challenge_list %}
						<tr>
							<td>{{ challenge.type }}</td>
							<td>
								{% if challenge.user_solve %}
								<span class="icon has-text-success"><i class="fas fa-check"></i></span>
								{% endif %}{{ challenge.name }}
							</td>
							<td>{{ challenge.solved }}</td>
							<td>
								<pre>{{ challenge.description }}</pre>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
				<!-- /Challenges -->

				{% if key %}
				<!-- Submit Flag -->
				<h1 class="title" id="flag">
					Submit Flag
				</h1>
				<form id="flag-form">
					{% csrf_token %}
					<div class="field has-addons">
						<div class="control">
							<input id="flag-input" class="input" type="text" name="flag" placeholder="Submit your flag here">
						</div>
						<div class="control">
							<button type="button" id="submit-flag" class="button is-primary">Submit</button>
						</div>
					</div>
				</form>
				<br>
				<div id="flag-notification" class="notification" style="display:none">
					<button class="delete"></button>
					<span class="content"></span>
				</div>
				<!-- /Submit Flag -->
				{% endif %}

				<h1 class="title" id="rank">
					Rank
				</h1>
				<table class="table is-hoverable is-fullwidth">
					<thead>
						<tr>
							<th>#</th>
							<th>ID</th>
							<th>Solved</th>
						</tr>
					</thead>
					<tbody>
						{% for r in rank %}
						<tr>
							<td>{{ forloop.counter }}</td>
							<td>{{ r.username }}</td>
							<td>{{ r.solved }}</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>

				<!-- Events -->
				<h1 class="title" id="events">
					Events
				</h1>
				<ul>
					{% for submit in submit_list %}
					<li><code>{{ submit.username.username }}</code> solved <code>{{ submit.challenge.name }}</code></li>
					{% endfor %}
				</ul>
				<!-- /Events -->

			</div>
			<!-- /Main Section -->

			<!-- Menu Section -->
			<div class="column">
				{% if not key %}
				<form action="login/" method="POST">
					{% csrf_token %}
					<div class="field has-addons">
						<div class="control">
							<input class="input" type="text" name="username" placeholder="Enter Username">
						</div>
						<div class="control">
							<button class="button is-primary">Login</button>
						</div>
					</div>
				</form>
				{% else %}
				<!-- User's Information -->
				<div class="card">
					<div class="card-content">
						<p class="title is-4">
							@{{username.username}}
						</p>
						<div class="content has-text-centered">
							<svg viewBox="0 0 36 36" class="circular-chart">
								<path class="circle-bg" d="M18 2.0845
									  a 15.9155 15.9155 0 0 1 0 31.831
									  a 15.9155 15.9155 0 0 1 0 -31.831" />
								<path class="circle" stroke-dasharray="{{solving_rate}}, 100" d="M18 2.0845
											a 15.9155 15.9155 0 0 1 0 31.831
											a 15.9155 15.9155 0 0 1 0 -31.831" />
								<text x="18" y="20.35" class="percentage">{{solving_rate}}%</text>
							</svg>
							<p>Solved: {{username.solved}}/{{challenge_list|length}}</p>
						</div>
						<a href="logout" class="card-footer-item button is-danger">Logout</a>
					</div>
				</div>
				<!-- /User's Information -->
				{% endif %}
				<hr>
				<aside class="menu">
					<ul class="menu-list">
						<li><a href="#challenges">Challenges</a></li>
						{% if key %}<li><a href="#flag">Submit Flag</a></li>{% endif %}
						<li><a href="#rank">Rank</a></li>
						<li><a href="#events">Events</a></li>
					</ul>
				</aside>
			</div>
			<!-- /Menu Section -->
		</div>
	</div>
	<footer class="footer">
		<div class="has-text-centered">
			<p>
				NTUSTISC
			</p>
			<a href="https://www.facebook.com/ntust.hacking/" target="_blank">
				<span class="icon">
					<i class="fab fa-facebook"></i>
				</span>
				Facebook
			</a>
		</div>
	</footer>

	<script>
		const close = document.getElementsByClassName('delete');
		for (let i = 0; i < close.length; i++) {
			close[i].onclick = () => {
				close[i].parentElement.style.display = 'none';
			}
		}

		const input = document.getElementById('flag-input');
		input.addEventListener("keydown", function (event) {
			if (event.keyCode === 13) {
				event.preventDefault();
				document.getElementById("submit-flag").click();
			}
		});

		document.getElementById('submit-flag').onclick = () => {
			fetch('flag/', {
				method: 'POST',
				body: new FormData(document.getElementById('flag-form'))
			})
				.then(r => r.json())
				.then(json => {
					const notification = document.getElementById('flag-notification');
					notification.style.display = 'block';
					if (json.correct) {
						notification.classList.add('is-success');
						notification.classList.remove('is-danger');
					} else {
						notification.classList.add('is-danger');
						notification.classList.remove('is-success');
					}
					notification.lastElementChild.innerHTML = json.message;
				})
		}
	</script>
</body>

</html>